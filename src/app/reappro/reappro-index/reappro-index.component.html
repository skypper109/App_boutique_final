
<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="medium" color="#fff" type="square-jelly-box" [fullScreen]="true">
  <p class="text-white mt-4 font-medium italic text-sm">Synchronisation des stocks...</p>
</ngx-spinner>

<div class="space-y-8 animate-fade-in mb-12">
  
  <!-- Page Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
    <div class="flex items-center space-x-5">
      <div class="w-14 h-14 bg-primary-600 rounded-2xl flex items-center justify-center text-white shadow-elegant-primary">
        <i class="bi bi-box-seam text-2xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-black text-secondary-900 tracking-tight text-secondary-900">Réapprovisionnement</h1>
        <p class="text-xs text-secondary-500 mt-1 font-medium italic">Optimisation et mise à jour des niveaux de stock</p>
      </div>
    </div>
    
    <div class="flex flex-wrap items-center gap-3">
      <a [routerLink]="['/ventes/new']" 
         class="px-5 py-2.5 bg-white border border-secondary-200 rounded-xl text-secondary-700 hover:text-primary-600 hover:bg-secondary-50 font-black text-[10px] uppercase tracking-widest transition-all shadow-sm flex items-center">
        <i class="bi bi-cart3 mr-2"></i>
        Faire une Vente
      </a>
      <a [routerLink]="['/produits/categories']"
         class="px-5 py-2.5 bg-white border border-secondary-200 rounded-xl text-secondary-700 hover:text-primary-600 hover:bg-secondary-50 font-black text-[10px] uppercase tracking-widest transition-all shadow-sm flex items-center">
        <i class="bi bi-tags mr-2"></i>
        Catégories
      </a>
    </div>
  </div>

  <!-- Search & Action Bar -->
  <div class="bg-white rounded-[2rem] p-8 shadow-elegant border border-secondary-100 flex flex-col md:flex-row items-center justify-between gap-6">
    <div class="relative w-full md:w-96 group">
      <input type="text" (keyup)="applyFilter($any($event))" placeholder="Rechercher un produit, une description..."
        class="w-full pl-12 pr-4 py-3.5 bg-secondary-50 border-none rounded-2xl focus:ring-2 focus:ring-primary-500/20 focus:bg-white transition-all text-sm font-bold text-secondary-700 placeholder:text-secondary-400 shadow-inner">
      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-secondary-400 group-focus-within:text-primary-500 transition-colors">
        <i class="bi bi-search text-xs"></i>
      </div>
    </div>

    <div class="flex items-center space-x-4">
       <div *ngIf="produitsChanger.length > 0" class="flex items-center space-x-3 animate-slide-in">
          <span class="px-3 py-1 bg-primary-50 text-primary-600 rounded-lg text-[10px] font-black uppercase tracking-widest border border-primary-100">
            {{ produitsChanger.length }} Modifications en attente
          </span>
          <button (click)="onValider()" 
                  class="px-8 py-4 bg-secondary-900 hover:bg-black text-white rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] shadow-elegant-dark transition-all transform active:scale-95 flex items-center h-14 group">
            <i class="bi bi-check2-circle mr-2.5 text-lg text-primary-400 group-hover:scale-110 transition-transform"></i>
            Valider le Stock
          </button>
       </div>
    </div>
  </div>

  <!-- Products Grid/Table -->
  <div class="bg-white rounded-3xl shadow-elegant border border-secondary-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-left whitespace-nowrap">
        <thead>
          <tr class="bg-secondary-50/50">
            <th class="px-8 py-5 text-[10px] font-black text-secondary-400 uppercase tracking-widest">Produit & Détails</th>
            <th class="px-4 py-5 text-[10px] font-black text-secondary-400 uppercase tracking-widest text-center">Catégorie</th>
            <th class="px-4 py-5 text-[10px] font-black text-secondary-400 uppercase tracking-widest text-center">Stock actuel</th>
            <th class="px-8 py-5 text-[10px] font-black text-secondary-400 uppercase tracking-widest text-right">Nouvelle quantité</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-secondary-50">
          <tr *ngFor="let p of paginatedProduits" class="hover:bg-primary-50/10 transition-colors group">
            <td class="px-8 py-6">
              <div class="flex items-center space-x-4">
                 <div class="w-12 h-12 rounded-2xl bg-secondary-50 border border-secondary-100 flex items-center justify-center text-secondary-400 group-hover:bg-white group-hover:text-primary-600 transition-all shadow-sm">
                    <i *ngIf="!p.image" class="bi bi-box text-xl"></i>
                    <img *ngIf="p.image" src="{{p.image}}" alt="" srcset="">
                 </div> 
                 <div>
                   <p class="text-sm font-black text-secondary-900 group-hover:text-primary-600 transition-colors">{{ p.nom }}</p>
                   <p class="text-[10px] text-secondary-400 font-bold uppercase tracking-tighter truncate max-w-[200px]">{{ p.reference || 'Pas de reference' }}</p>
                 </div>
              </div>
            </td>
            <td class="px-4 py-6 text-center">
              <span class="px-2.5 py-1 bg-secondary-100 text-secondary-700 rounded-lg text-[9px] font-black uppercase tracking-widest">
                {{ p.categorie?.nom }}
              </span>
            </td>
            <td class="px-4 py-6 text-center">
              <div class="inline-flex flex-col items-center">
                <span class="text-sm font-black text-secondary-900">{{ p.stock?.quantite }}</span>
                <span class="text-[9px] font-black text-secondary-400 uppercase tracking-tighter italic">unités</span>
              </div>
            </td>
            <td class="px-8 py-6 text-right">
              <div class="flex items-center justify-end">
                <div class="relative w-32 group/input">
                   <input type="number" 
                          placeholder="Ajouter..."
                          (input)="onQuantityChange($any($event), p)"
                          class="w-full pl-4 pr-10 py-2.5 bg-secondary-50 border-none rounded-xl focus:ring-2 focus:ring-primary-500/20 focus:bg-white transition-all text-sm font-black text-secondary-900 text-center appearance-none"
                          min="0">
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-secondary-300 group-focus-within/input:text-primary-500">
                    <i class="bi bi-plus-lg text-xs"></i>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="flex items-center justify-between p-8 border-t border-secondary-100" *ngIf="totalPages > 1">
          <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1" 
                  class="px-5 py-2.5 rounded-xl bg-white border border-secondary-200 text-secondary-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-secondary-50 transition-all font-black text-[10px] uppercase tracking-wider shadow-sm flex items-center">
              <i class="bi bi-chevron-left mr-2"></i> Précédent
          </button>
          
          <div class="flex gap-2">
              <button *ngFor="let page of pages" (click)="changePage(page)" 
                      [class.bg-primary-600]="currentPage === page" 
                      [class.text-white]="currentPage === page" 
                      [class.bg-white]="currentPage !== page" 
                      [class.text-secondary-600]="currentPage !== page"
                      class="w-9 h-9 rounded-xl flex items-center justify-center font-black text-xs transition-all shadow-sm border border-secondary-200"
                      [ngClass]="currentPage === page ? 'border-primary-600' : 'hover:bg-secondary-50'">
                  {{ page }}
              </button>
          </div>

          <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages" 
                  class="px-5 py-2.5 rounded-xl bg-white border border-secondary-200 text-secondary-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-secondary-50 transition-all font-black text-[10px] uppercase tracking-wider shadow-sm flex items-center">
              Suivant <i class="bi bi-chevron-right mr-2"></i>
          </button>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="!produits.length" class="py-24 text-center">
        <div class="w-16 h-16 bg-secondary-100 rounded-full flex items-center justify-center mx-auto mb-4 text-secondary-200">
          <i class="bi bi-inbox text-3xl"></i>
        </div>
        <p class="text-secondary-400 font-bold italic">Aucun produit ne nécessite de réapprovisionnement pour le moment.</p>
        <button (click)="ngOnInit()" class="mt-4 text-primary-600 font-black text-xs uppercase tracking-widest hover:underline">Rafraîchir la liste</button>
      </div>
    </div>
  </div>

</div>
