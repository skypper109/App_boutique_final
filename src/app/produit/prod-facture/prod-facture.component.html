<ngx-spinner bdColor="rgba(15, 23, 42, 0.95)" size="medium" color="#fbbf24" type="ball-scale-multiple" [fullScreen]="true">
  <p class="text-white mt-4 font-black tracking-widest uppercase text-[10px]">Édition du Document de Luxe...</p>
</ngx-spinner>

<!-- Custom Typography
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"> -->

<style>
  :host { font-family: 'Inter', sans-serif; }
  .serif-title { font-family: 'Cormorant Garamond', serif; }
  @media print {
    @page { size: A4; margin: 0; }
    body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .print-container {
      width: 210mm;
      height: 297mm;
      margin: 0 auto;
      padding: 10mm 15mm !important;
      box-shadow: none !important;
      border: none !important;
      display: flex;
      flex-direction: column;
    }
    .no-print { display: none !important; }
    tr { page-break-inside: avoid; }
    thead { display: table-header-group; }
    .footer-print { margin-top: auto; padding-bottom: 10mm; }
  }
</style>

<div class="min-h-screen bg-[#F8F9FA] py-8 px-4 d-print-none no-print" *ngIf="produitAcheter.length">
  
  <!-- Control Bar -->
  <div class="max-w-[210mm] mx-auto mb-6 flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100 no-print">
    <button [routerLink]="['/produits/list']" class="h-10 px-4 flex items-center gap-2 text-slate-500 hover:text-black transition-all font-bold text-[10px] uppercase tracking-widest group">
      <i class="bi bi-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i>
      Retour
    </button>
    <div class="flex gap-2">
      <button (click)="print()" class="h-10 px-5 bg-slate-900 text-white rounded-xl shadow-md flex items-center gap-2 hover:bg-black transition-all font-bold text-[10px] uppercase tracking-wider">
        <i class="bi bi-printer"></i> Imprimer
      </button>
      <button (click)="exportPDF()" class="h-10 px-5 bg-white border border-slate-200 text-slate-900 rounded-xl flex items-center gap-2 hover:bg-slate-50 transition-all font-bold text-[10px] uppercase tracking-wider">
        <i class="bi bi-download"></i> PDF
      </button>
    </div>
  </div>

  <!-- Screen View -->
  <div class="max-w-[210mm] mx-auto bg-white shadow-[0_40px_100px_rgba(0,0,0,0.03)] border border-slate-100 overflow-hidden relative p-[15mm]">
    <!-- Branding -->
    <div class="flex justify-between items-start mb-6">
      <div class="space-y-4">
        <div class="space-y-0.5">
          <h1 class="text-3xl serif-title font-bold text-slate-900 leading-none tracking-tight">{{nomBoutique}}</h1>
          <div class="flex items-center gap-2">
            <span class="h-[1px] w-4 bg-amber-400"></span>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.4em]">{{ nomBoutique || '-----' }}</p>
          </div>
        </div>
        <div class="space-y-0.5 pl-4 border-l border-slate-200 mb-2">
          <p class="text-[10px] font-bold text-slate-800">{{ adresseBoutique || '-----' }}</p>
          <p class="text-[10px] font-medium text-slate-500">Mali | {{ telBoutique || '-----' }}</p>
        </div>
      </div>

      <div class="text-right">
        <div class="mb-4">
          <p class="text-[8px] font-black text-slate-200 uppercase tracking-[0.4em] mb-0.5">FACTURE #</p>
          <p class="text-2xl font-black text-slate-900 tracking-tighter">{{idFacture}}</p>
        </div>
        <div class="bg-slate-50 border border-slate-100 px-4 py-2 rounded-xl inline-block text-left">
          <p class="text-[8px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-0.5">Date d'émission</p>
          <p class="text-[10px] font-black text-slate-900 uppercase">
            {{dateFacture | date:'dd MMM yyyy'}}
          </p>
        </div>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-12 gap-8 mb-8 pb-6 border-b border-slate-50">
      <div class="col-span-8">
        <h3 class="text-[8px] font-black text-slate-300 uppercase tracking-[0.4em] mb-3 px-1">CLIENT</h3>
        <p class="text-xl font-bold text-slate-900 leading-none mb-2 px-1">{{nomClient}}</p>
        <div class="flex gap-8 mt-2 px-1">
          <div class="space-y-0.5">
            <span class="text-[8px] font-bold text-slate-300 uppercase tracking-widest">Adresse</span>
            <p class="text-[10px] font-semibold text-slate-600">{{adresseClient || 'N/A'}}</p>
          </div>
          <div class="space-y-0.5">
            <span class="text-[8px] font-bold text-slate-300 uppercase tracking-widest">Contact</span>
            <p class="text-[10px] font-semibold text-slate-600">{{numeroClient || 'N/A'}}</p>
          </div>
        </div>
      </div>
      <div class="col-span-4 flex flex-col items-end justify-end pb-1 pr-2">
        <p class="text-[8px] font-black text-slate-300 uppercase tracking-[0.3em] mb-1.5">PAIEMENT</p>
        <div class="flex items-center gap-1.5">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
          <p class="text-[10px] font-black text-slate-900 uppercase tracking-wider">CASH / RÉGLÉ</p>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="mb-8">
      <table class="w-full">
        <thead>
          <tr class="bg-slate-50">
            <th class="py-2.5 px-3 text-left text-[9px] font-black text-slate-400 uppercase tracking-widest rounded-l-lg">ID</th>
            <th class="py-2.5 px-3 text-left text-[9px] font-black text-slate-400 uppercase tracking-widest">Désignation</th>
            <th class="py-2.5 px-3 text-center text-[9px] font-black text-slate-400 uppercase tracking-widest">Qté</th>
            <th class="py-2.5 px-3 text-right text-[9px] font-black text-slate-400 uppercase tracking-widest">Prix HT</th>
            <th class="py-2.5 px-3 text-right text-[9px] font-black text-slate-900 uppercase tracking-widest rounded-r-lg">Total HT</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-50">
          <tr *ngFor="let prod of produitAcheter; let i = index">
            <td class="py-3 px-3 text-[10px] font-bold text-slate-300">#{{(i + 1)}}</td>
            <td class="py-3 px-3">
              <p class="text-[11px] font-bold text-slate-900 mb-0.5 tracking-tight uppercase">{{prod.nomProduit}}</p>
              <p class="text-[8px] text-slate-400 font-medium uppercase tracking-tighter">Premium Collection</p>
            </td>
            <td class="py-3 px-3 text-center text-[11px] font-bold text-slate-900">{{prod.quantite}}</td>
            <td class="py-3 px-3 text-right text-[10px] font-medium text-slate-600 tabular-nums">{{prod.prixUnitaire | number:'1.0'}}</td>
            <td class="py-3 px-3 text-right text-[12px] font-black text-slate-900 tabular-nums">{{prod.montant | number:'1.0'}}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Summary -->
    <div class="grid grid-cols-12 gap-8 items-end mb-8">
      <div class="col-span-7">
        <div class="bg-slate-50/50 rounded-2xl p-4 border border-slate-100 mb-4">
          <p class="text-[8px] font-black text-amber-500 uppercase tracking-widest mb-1.5">POLITIQUE DE RETOUR</p>
          <p class="text-[9px] text-slate-400 leading-tight font-medium italic">
            Les articles doivent être retournés sous 48h dans leur emballage d'origine. 
            Aucun échange ne sera accepté sans ce ticket de caisse.
          </p>
        </div>
      </div>
      <div class="col-span-5 space-y-3">
        <div class="space-y-2 px-2 pb-2 border-b border-slate-100">
          <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest">
            <span>Sous-Total</span>
            <span class="text-slate-900">{{montant_total | number:'1.0'}}</span>
          </div>
          <div class="flex justify-between text-[10px] font-bold text-emerald-500 uppercase tracking-widest">
            <span>Remise</span>
            <span>{{montant_remis | number:'1.0'}}</span>
          </div>
        </div>
        <div class="bg-slate-900 rounded-3xl p-5 text-white shadow-xl flex justify-between items-center relative overflow-hidden">
          <div class="relative z-10">
            <p class="text-[8px] font-black text-amber-400 uppercase tracking-widest mb-1">CASH TOTAL</p>
            <p class="text-3xl font-black tracking-tighter">{{ (montant_total - montant_remis) | number:'1.0' }} <span class="text-[10px] font-bold opacity-30">CFA</span></p>
          </div>
          <i class="bi bi-qr-code text-2xl opacity-20"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Premium Print Version (A4 Compact) -->
<div id="printable-facture" class="fixed -left-[9999px] top-0 print:static print:block print-container bg-white" *ngIf="produitAcheter.length">
  <div class="flex justify-between items-start mb-8 pb-6 border-b-2 border-slate-900">
    <div class="space-y-4">
      <div class="space-y-0.5">
        <h1 class="text-3xl serif-title font-bold text-slate-900 leading-none">{{ nomBoutique || '-----' }}</h1>
        <p class="text-[9px] font-bold text-amber-500 uppercase tracking-[0.4em]">HAUTE COLLECTION</p>
      </div>
      <div class="text-[9px] font-bold text-slate-400 space-y-0.5 uppercase tracking-widest">
        <p>{{ adresseBoutique || '-----' }}</p>
        <p>Tél: {{ telBoutique || '-----' }}</p>
      </div>
    </div>
    <div class="text-right">
      <h2 class="text-3xl font-black tracking-tightest leading-none">FACTURE</h2>
      <div class="mt-2 space-y-1">
        <p class="text-sm font-black text-slate-900">N° {{idFacture}}</p>
        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{{dateFacture | date:'dd / MM / yyyy'}}</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-8 mb-8 pb-4 border-b border-slate-50">
    <div class="space-y-1 px-1">
      <span class="text-[8px] font-black text-slate-200 uppercase tracking-widest">Destinataire</span>
      <p class="text-lg font-bold text-slate-900 leading-tight uppercase">{{nomClient}}</p>
    </div>
    <div class="text-right space-y-1 px-1">
      <span class="text-[8px] font-black text-slate-200 uppercase tracking-widest">Paiement</span>
      <p class="text-[11px] font-black text-emerald-500 uppercase tracking-widest">CASH / RÉGLÉ</p>
    </div>
  </div>

  <div class="flex-grow">
    <table class="w-full mb-10 border-collapse">
      <thead>
        <tr class="bg-slate-50">
          <th class="py-2.5 px-3 text-left text-[9px] font-black text-slate-400 uppercase tracking-widest">Désignation</th>
          <th class="py-2.5 px-3 text-center text-[9px] font-black text-slate-400 uppercase tracking-widest w-16">Qté</th>
          <th class="py-2.5 px-3 text-right text-[9px] font-black text-slate-400 uppercase tracking-widest w-24">Prix Unit.</th>
          <th class="py-2.5 px-3 text-right text-[9px] font-black text-slate-900 uppercase tracking-widest w-32">Montant</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        <tr *ngFor="let prod of produitAcheter" class="text-[10px]">
          <td class="py-3 px-3">
            <p class="font-bold text-slate-900 uppercase">{{prod.nomProduit}}</p>
            <p class="text-[8px] text-slate-400 italic">Premium Selection</p>
          </td>
          <td class="py-3 px-3 text-center font-bold text-slate-700">{{prod.quantite}}</td>
          <td class="py-3 px-3 text-right tabular-nums">{{prod.prixUnitaire | number:'1.0'}}</td>
          <td class="py-3 px-3 text-right font-black text-slate-900 tabular-nums">{{prod.montant | number:'1.0'}}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="footer-print">
    <div class="flex justify-between items-end mb-12">
       <div class="flex-1 pr-10">
          <div class="p-4 bg-slate-50/50 rounded-2xl border border-slate-100 italic text-[9px] text-slate-400 leading-tight">
            Note: Aucun échange ne sera accepté sans ce ticket de caisse original. Les articles ne sont ni repris ni remboursés après 48h.
          </div>
       </div>
       <div class="w-64 space-y-3">
          <div class="flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-widest px-2">
            <span>Sous-Total</span>
            <span class="text-slate-900">{{montant_total | number:'1.0'}}</span>
          </div>
          <div class="flex justify-between text-[9px] font-black text-emerald-500 uppercase tracking-widest px-2 border-b border-slate-100 pb-2">
            <span>Remise</span>
            <span>- {{montant_remis | number:'1.0'}}</span>
          </div>
          <div class="bg-slate-900 text-white rounded-3xl p-5 shadow-xl relative overflow-hidden text-right">
             <div class="relative z-10">
                <span class="block text-[8px] font-black text-amber-400 uppercase tracking-widest mb-1">NET A PAYER</span>
                <p class="text-3xl font-black tracking-tighter">{{ (montant_total - montant_remis) | number:'1.0' }} <span class="text-[10px] opacity-40">CFA</span></p>
             </div>
          </div>
       </div>
    </div>
    <p class="text-center text-[7px] text-slate-200 mt-10 uppercase tracking-[0.5em]">DOCUMENT OFFICEL DE GESTION - MERCI DE VOTRE CONFIANCE</p>
  </div>
</div>

<div *ngIf="!produitAcheter.length" class="min-h-screen flex items-center justify-center bg-[#F8F9FA] no-print">
  <div class="text-center opacity-10">
     <i class="bi bi-file-earmark-x text-6xl"></i>
  </div>
</div>
