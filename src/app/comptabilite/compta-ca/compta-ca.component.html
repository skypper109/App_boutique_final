
<ngx-spinner bdColor="rgba(15, 23, 42, 0.9)" size="medium" color="#3b82f6" type="square-jelly-box" [fullScreen]="true">
  <p class="text-white mt-4 font-bold tracking-widest uppercase text-[10px]">Analyse des données en cours...</p>
</ngx-spinner>

<div class="max-w-[1600px] mx-auto space-y-8 animate-fade-in pb-12">
  
  <!-- Modern Header Section -->
  <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-secondary-100 flex flex-col lg:flex-row lg:items-center justify-between gap-8">
    <div class="space-y-2">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary-50 rounded-2xl flex items-center justify-center text-primary-600">
          <i class="bi bi-graph-up-arrow text-xl"></i>
        </div>
        <h1 class="text-3xl font-black text-secondary-900 tracking-tight">Performance Financière</h1>
      </div>
      <nav class="flex text-xs font-bold uppercase tracking-wider text-secondary-400">
        <a [routerLink]="['/accueil']" class="hover:text-primary-600 transition-colors">Tableau de bord</a>
        <span class="mx-3 opacity-30">/</span>
        <span class="text-secondary-900">Rapports CA</span>
      </nav>
    </div>
    
    <div class="flex flex-wrap items-center gap-4">
      <div class="relative min-w-[200px]">
        <select [(ngModel)]="annee" (change)="getChiffreAffaire(annee)"
          class="w-full pl-11 pr-10 py-3.5 bg-secondary-50 border-none rounded-2xl focus:ring-4 focus:ring-primary-500/10 transition-all text-sm font-black text-secondary-900 shadow-inner cursor-pointer appearance-none">
          <option [ngValue]="undefined" disabled selected>Sélectionner l'exercice</option>
          <option *ngFor="let y of annees" [value]="y.annee">Exercice {{ y.annee }}</option>
        </select>
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-primary-500">
          <i class="bi bi-calendar3"></i>
        </div>
        <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-secondary-400">
          <i class="bi bi-chevron-down text-xs"></i>
        </div>
      </div>
      
      <button class="px-6 py-3.5 bg-primary-600 text-white rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-primary-700 hover:shadow-lg hover:shadow-primary-500/30 transition-all flex items-center gap-3 active:scale-95">
        <i class="bi bi-file-earmark-pdf-fill"></i>
        <span>Rapport Complet</span>
      </button>
    </div>
  </div>

  <!-- Key Metrics Dashboard -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- Revenue Card -->
    <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-secondary-100 group hover:border-primary-200 transition-colors">
      <div class="flex justify-between items-start mb-6">
        <div class="w-14 h-14 bg-emerald-50 rounded-[1.25rem] flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-all duration-500">
          <i class="bi bi-currency-exchange text-2xl"></i>
        </div>
        <span class="text-[10px] font-black text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full uppercase tracking-widest">En hausse</span>
      </div>
      <p class="text-[11px] font-black text-secondary-400 uppercase tracking-[0.15em] mb-1">Chiffre d'Affaires</p>
      <div class="flex items-baseline gap-2">
        <h2 class="text-3xl font-black text-secondary-900 tracking-tighter">{{ totalCA | number:'1.0' }}</h2>
        <span class="text-xs font-black text-secondary-400">FCFA</span>
      </div>
    </div>

    <!-- Profit Card (New) -->
    <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-secondary-100 group hover:border-primary-200 transition-colors">
      <div class="flex justify-between items-start mb-6">
        <div class="w-14 h-14 bg-primary-50 rounded-[1.25rem] flex items-center justify-center text-primary-600 group-hover:bg-primary-600 group-hover:text-white transition-all duration-500">
          <i class="bi bi-piggy-bank text-2xl"></i>
        </div>
        <span class="text-[10px] font-black text-primary-600 bg-primary-50 px-3 py-1.5 rounded-full uppercase tracking-widest">Bénéfice Net</span>
      </div>
      <p class="text-[11px] font-black text-secondary-400 uppercase tracking-[0.15em] mb-1">Bénéfice Réalisé</p>
      <div class="flex items-baseline gap-2">
        <h2 class="text-3xl font-black text-secondary-900 tracking-tighter text-primary-600">{{ totalBenefice | number:'1.0' }}</h2>
        <span class="text-xs font-black text-secondary-400">FCFA</span>
      </div>
    </div>

    <!-- Sales Card -->
    <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-secondary-100 group hover:border-blue-200 transition-colors">
      <div class="flex justify-between items-start mb-6">
        <div class="w-14 h-14 bg-blue-50 rounded-[1.25rem] flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-all duration-500">
          <i class="bi bi-cart4 text-2xl"></i>
        </div>
        <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full uppercase tracking-widest">{{ totalQtv || 0 }} Ventes</span>
      </div>
      <p class="text-[11px] font-black text-secondary-400 uppercase tracking-[0.15em] mb-1">Volume de Ventes</p>
      <h2 class="text-3xl font-black text-secondary-900 tracking-tighter">{{ totalQtv | number }}</h2>
    </div>

    <!-- Analytics Card -->
    <div class="bg-secondary-900 rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden group">
      <div class="absolute -right-8 -bottom-8 w-40 h-40 bg-primary-600/10 rounded-full blur-3xl group-hover:bg-primary-600/20 transition-colors"></div>
      <div class="relative z-10 space-y-4">
        <p class="text-[10px] font-black text-primary-400 uppercase tracking-widest">Performance {{ annee }}</p>
        <h3 class="text-lg font-bold text-white leading-tight">Marges Brutes</h3>
        <p class="text-xs text-secondary-400 font-medium leading-relaxed italic opacity-80">
          Analyse consolidée des revenus et marges commerciales bénéficiaires.
        </p>
      </div>
    </div>
  </div>

  <!-- Chart & Insights -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <div class="lg:col-span-12 bg-white rounded-[2.5rem] p-10 shadow-sm border border-secondary-100">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-10">
        <div>
          <h3 class="text-2xl font-black text-secondary-900">Courbe de Croissance</h3>
          <p class="text-sm text-secondary-500 font-medium mt-1 uppercase tracking-wide">Évolution mensuelle des revenus cumulés</p>
        </div>
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-3">
            <span class="w-4 h-1.5 bg-primary-500 rounded-full"></span>
            <span class="text-[10px] font-black text-secondary-600 uppercase tracking-widest">Chiffre d'Affaires</span>
          </div>
        </div>
      </div>
      
      <!-- Chart Container with overflow fix -->
      <div class="relative w-full overflow-hidden" style="height: 350px;">
        <canvas #caChart></canvas>
      </div>
    </div>

    <!-- Detailed Analysis Table -->
    <div class="lg:col-span-12 bg-white rounded-[2.5rem] shadow-sm border border-secondary-100 overflow-hidden">
      <div class="px-10 py-8 border-b border-secondary-50 flex items-center justify-between bg-white">
        <h3 class="text-xl font-black text-secondary-900 tracking-tight italic">Journal des Revenus & Marges</h3>
        <div class="w-12 h-1 bg-secondary-100 rounded-full"></div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-secondary-50">
              <th class="px-10 py-6 text-[11px] font-black text-secondary-500 uppercase tracking-[0.2em]">Période</th>
              <th class="px-6 py-6 text-[11px] font-black text-secondary-500 uppercase tracking-[0.2em] text-center">Volume Vente</th>
              <th class="px-6 py-6 text-[11px] font-black text-secondary-500 uppercase tracking-[0.2em] text-right">CA Net</th>
              <th class="px-6 py-6 text-[11px] font-black text-secondary-500 uppercase tracking-[0.2em] text-right">Marge Brute</th>
              <th class="px-10 py-6 text-[11px] font-black text-secondary-500 uppercase tracking-[0.2em] text-right text-primary-600">Bénéfice Net</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-secondary-50">
            <tr *ngFor="let c of chiffres.reverse()" class="group hover:bg-secondary-50 transition-all duration-300">
              <td class="px-10 py-7">
                <div class="flex items-center gap-4">
                  <div class="w-1 h-8 bg-secondary-200 group-hover:bg-primary-500 rounded-full transition-all duration-500"></div>
                  <div>
                    <span class="block text-base font-black text-secondary-900 leading-none group-hover:translate-x-1 transition-transform">{{ getMonthName(c.mois_num) }}</span>
                    <span class="text-[10px] font-black text-secondary-400 uppercase tracking-widest mt-1 block">{{ annee }}</span>
                  </div>
                </div>
              </td>
              <td class="px-6 py-7 text-center">
                <div class="inline-block px-4 py-2 bg-secondary-50 group-hover:bg-white border border-secondary-100 rounded-xl transition-all">
                  <span class="text-sm font-black text-secondary-900">{{ c.qtv }}</span>
                  <span class="text-[10px] font-bold text-secondary-400 uppercase ml-1.5 opacity-60">unit.</span>
                </div>
              </td>
              <td class="px-6 py-7 text-right">
                <div class="flex flex-col items-end">
                  <span class="text-sm font-black text-secondary-900 tracking-tighter">{{ c.ca | number:'1.0' }}</span>
                  <span class="text-[9px] font-black text-secondary-400 uppercase">FCFA</span>
                </div>
              </td>
              <td class="px-6 py-7 text-right">
                <div class="flex flex-col items-end">
                  <span class="text-sm font-bold text-secondary-500 tracking-tighter">{{ (c.cout_achat || 0) | number:'1.0' }}</span>
                  <span class="text-[9px] font-black text-secondary-300 uppercase">Achat</span>
                </div>
              </td>
              <td class="px-10 py-7 text-right">
                <div class="flex flex-col items-end group-hover:scale-105 transition-transform">
                  <span class="text-base font-black text-primary-600 tracking-tighter">{{ (c.ca - (c.cout_achat || 0)) | number:'1.0' }}</span>
                  <span class="text-[9px] font-black text-primary-500 tracking-[0.2em] uppercase mt-1 italic">Profit</span>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot class="bg-primary-600 text-white border-t-4 border-primary-700">
            <tr>
              <td class="px-10 py-8 text-sm font-bold uppercase tracking-[0.3em]">Total Consolidé</td>
              <td class="px-6 py-8 text-center ring-1 ring-white/10">
                <div class="inline-flex items-baseline gap-2">
                  <span class="text-2xl font-black tracking-tight">{{ totalQtv | number }}</span>
                </div>
              </td>
              <td class="px-6 py-8 text-right bg-primary-700">
                <div class="flex flex-col items-end">
                  <span class="text-2xl font-black tracking-tighter">{{ totalCA | number:'1.0' }}</span>
                  <span class="text-[10px] font-black text-primary-300 tracking-[0.2em]">C.A.</span>
                </div>
              </td>
              <td class="px-6 py-8"></td> <!-- Empty for margin align -->
              <td class="px-10 py-8 text-right bg-secondary-900">
                <div class="flex flex-col items-end">
                  <span class="text-3xl font-black tracking-tighter text-primary-400">{{ totalBenefice | number:'1.0' }}</span>
                  <span class="text-xs font-black text-white/50 tracking-[0.3em] uppercase">Bénéfice</span>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
        
        <!-- Premium Empty State -->
        <div *ngIf="!chiffres?.length" class="py-32 flex flex-col items-center justify-center text-center">
          <div class="w-24 h-24 bg-secondary-50 rounded-[2.5rem] flex items-center justify-center mb-6 border border-secondary-100 shadow-inner">
            <i class="bi bi-bar-chart-line text-4xl text-secondary-200"></i>
          </div>
          <h4 class="text-xl font-bold text-secondary-900 mb-2">Données Indisponibles</h4>
          <p class="text-sm text-secondary-400 font-medium max-w-xs mx-auto">Aucune transaction n'a été enregistrée pour l'exercice {{ annee }} dans cette boutique.</p>
        </div>
      </div>
    </div>
  </div>
</div>
